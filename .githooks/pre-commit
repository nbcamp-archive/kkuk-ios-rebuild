#!/bin/sh

# swiftlint
LINT=$(which swiftlint)

if [[ -e "${LINT}" ]]; then
	echo "HookğŸª: SwiftLint ê²€ì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
else
	echo "HookğŸª: SwiftLintê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
	echo "$(brew install swiftlint) ëª…ë ¹ì–´ë¥¼ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•´ì£¼ì„¸ìš”."
	exit 1
fi

FILES=$(git diff --stat --cached)
TARGETS=$(git diff --stat --cached --diff-filter=d --name-only $(git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)) | grep -F ".swift")

if [ -n "$FILES" -a -z "$TARGETS" ]; then
	printf "HookğŸª: ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤."
	exit 0

elif [ -z "${FILES}" ]; then
	printf ""
	printf "\n 'git add' ëª…ë ¹ì–´ë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”."
	exit 1

elif [ -z "${TARGETS}" ]; then
	printf "HookğŸª: ë³€ê²½ëœ Swift íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
	printf "\n 'git add' ëª…ë ¹ì–´ë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”."
	exit 1
fi

# swiftlint apply custom rules to only staged files
RESULTS=$($LINT lint --quiet --config .swiftlint.yml)
STAGED_FILES=$(git diff --cached --name-only | grep ".swift$")
if [[ "$STAGED_FILES" = "" ]]; then 
    printf "HookğŸª: ë³€ê²½ëœ Swift íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
    exit 0
else
    for FILE in $STAGED_FILES; do
        RESULTS=$($LINT lint --quiet "$FILE" --config .swiftlint.yml)
    done
fi
if [ "$RESULTS" == "" ]; then
	printf "HookğŸª: SwiftLint ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤.\n"
	exit 0
else
	echo ""
	printf "HookğŸª: SwiftLint ê²€ì‚¬ë¥¼ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n"
	echo "$RESULTS" | while read -r line; do
		FILEPATH=$(echo "$line" | cut -d : -f 1)
		L=$(echo "$line" | cut -d : -f 2)
		C=$(echo "$line" | cut -d : -f 3)
		TYPE=$(echo "$line" | cut -d : -f 4 | cut -c 2-)
		MESSAGE=$(echo "$line" | cut -d : -f 5 | cut -c 2-)
		DESCRIPTION=$(echo "$line" | cut -d : -f 6 | cut -c 2-)
		if [ $TYPE = "warning" ]; then
			printf "\033[0;33m$TYPE âš ï¸\033[0m\n"
			# warningì¼ ê²½ìš°ì—ëŠ” ì»¤ë°‹ì„ ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ë ¤ë©´ ì£¼ì„ í•´ì œ
      # printf "$FILEPATH:$L:$C\n"
      # printf "$MESSAGE: - $DESCRIPTION\n"
      # exit 0
		elif [ $TYPE = "error" ]; then
			printf "\033[0;31m$TYPE âŒ \033[0m\n"
		fi
		printf "$FILEPATH:$L:$C\n"
		printf "$MESSAGE: - $DESCRIPTION\n"
	done
	printf "\n HookğŸª: SwiftLint rulesì— ë§ì¶° ì½”ë“œë¥¼ ì •ë¦¬í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤.\n"
	exit 1
fi